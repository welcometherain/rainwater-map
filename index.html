<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainwater Capture Map</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }

        #area,
        #capture,
        #gallonsPerInch {
            font-weight: bold;
        }

        #calculate, #clearResults {
            background-color: #EC19C2;
            color: white;
            font-size: 1.2em;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 200px;
            text-align: center;
        }

        #results-space {
            margin-bottom: 20px;
        }

        #areasList {
            margin-top: 10px;
        }

        #directions {
            background-color: #2C3E50;
            color: white;
            padding: 10px;
            font-family: 'Quattrocento Sans', sans-serif;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMjSUEz0qI4IhB-0PyNlnxH8CHl-R5o1k&libraries=places"></script> <!-- Your API key -->
</head>

<body>
    <div id="directions">
        <h3>Directions:</h3>
        <ol>
            <li>Click on the map to draw a polygon around the area where you want to capture rainwater.</li>
            <li>Enter your address to zoom into that location and draw a polygon on your roof or another area of interest.</li>
            <li>After drawing the polygon, the app will automatically calculate the area (in square feet) and the amount of rainwater you can capture based on your annual rainfall input.</li>
            <li>Click "Clear Results" to reset the map and input fields.</li>
        </ol>
    </div>

    <div id="map"></div>

    <p>Enter Address: <input type="text" id="addressInput">
        <button id="searchAddress">Search</button>
    </p>
    <p>
        Enter Your Annual Rainfall (in inches):
        <input type="number" id="rainfall" value="12" />
        <br />
        <a href="https://precip.ai/rainfall-totals/zipcode/" target="_blank">
            Find Rainfall by Zip Code
        </a>
    </p>

    <button id="calculate">Calculate</button>
    <button id="clearResults">Clear Results</button>

    <div id="results-space"></div>
    <p>Area (square feet): <span id="area"></span></p>
    <p>Potential Annual Rainwater Harvesting in Gallons: <span id="capture"></span></p>
    <p>Gallons of Rainwater per Inch of Rain: <span id="gallonsPerInch"></span></p>
    <div id="areasList"></div>

    <script>
        window.onload = function() {
            const map = L.map('map').setView([32.7157, -117.1611], 11);

            // Adding the map layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Initialize the drawn items layer
            let drawnItems = new L.FeatureGroup().addTo(map);
            let drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems
                },
                draw: {
                    rectangle: false, // Disable the rectangle tool
                    circle: false,
                    marker: false,
                    circlemarker: false,
                    polyline: false
                },
            });
            map.addControl(drawControl);

            // Function for creating a new polygon
            map.on(L.Draw.Event.CREATED, function(event) {
                let layer = event.layer;
                drawnItems.addLayer(layer);

                // Calculating the area and updating the results
                let geojson = layer.toGeoJSON();
                let areaMeters = turf.area(geojson);
                let areaFeet = Math.round(areaMeters * 10.7639); // convert from meters² to feet²
                document.getElementById('area').textContent = areaFeet.toLocaleString();
                let rainfall = parseFloat(document.getElementById('rainfall').value) || 12;
                let capture = areaFeet * rainfall;
                document.getElementById('capture').textContent = capture.toLocaleString();
                let gallonsPerInch = areaFeet * 0.6237; // Gallons per inch calculation
                document.getElementById('gallonsPerInch').textContent = gallonsPerInch.toLocaleString();
            });

            // Function to reset results
            document.getElementById('clearResults').addEventListener('click', function() {
                drawnItems.clearLayers();
                document.getElementById('area').textContent = '';
                document.getElementById('capture').textContent = '';
                document.getElementById('gallonsPerInch').textContent = '';
            });

            // Autocomplete API initialization
            let autocomplete = new google.maps.places.Autocomplete(document.getElementById('addressInput'));
            autocomplete.addListener('place_changed', function() {
                let place = autocomplete.getPlace();
                if (place.geometry) {
                    map.setCenter(place.geometry.location);
                    map.setZoom(19); // Zoom in when the address is selected
                }
            });

            // Address search on click (optional, can also use Enter key)
            document.getElementById('searchAddress').addEventListener('click', function() {
                let address = document.getElementById('addressInput').value;
                let geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': address }, function(results, status) {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(19); // Zoom in after address search
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    }
                });
            });

            // Allow search by pressing Enter key
            document.getElementById('addressInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    document.getElementById('searchAddress').click();
                }
            });
        };
    </script>
</body>
</html>
