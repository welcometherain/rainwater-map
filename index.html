<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainwater Capture Map</title>

    <!-- Google Fonts: Quattrocento Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Quattrocento+Sans&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Quattrocento Sans', sans-serif;
        }

        #map {
            height: 600px;
            width: 100%;
        }

        #area, #capture, #gallonsPerInch {
            font-weight: bold;
        }

        #clearResults, #calculate {
            background-color: #EC19C2;
            color: white;
            font-size: 1.2em;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
            width: auto;
            font-family: 'Quattrocento Sans', sans-serif;
        }

        #results-space {
            margin-bottom: 20px;
        }

        #areasList {
            margin-top: 10px;
        }

        input, button {
            font-family: 'Quattrocento Sans', sans-serif;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

</head>
<body>
    <div id="map"></div>
    <p>Enter Address or Scroll the Map: <input type="text" id="addressInput">
        <button id="searchAddress">Search</button>
    </p>
    <p>
        Enter Your Annual Rainfall (in inches):
        <input type="number" id="rainfall" value="12"/>
        <br />
        <a href="https://precip.ai/rainfall-totals/zipcode/" target="_blank">
            Find Rainfall by Zip Code
        </a>
    </p>
    <button id="calculate">Calculate</button>
    <button id="clearResults">Clear Results</button>
    <div id="results-space"></div>
    <p>Area (square feet): <span id="area"></span></p>
    <p>Potential Annual Rainwater Harvesting in Gallons: <span id="capture"></span></p>
    <p>Gallons of Rainwater per Inch of Rain: <span id="gallonsPerInch"></span></p>
    <div id="areasList"></div>

    <script>
        let map = L.map('map').setView([32.7157, -117.1611], 11);

        let satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>',
            maxZoom: 23
        });

        let hybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>',
            maxZoom: 23
        });

        let baseMaps = {
            "Satellite": satellite,
            "Hybrid": hybrid
        };

        hybrid.addTo(map);
        L.control.layers(baseMaps).addTo(map);

        let drawnItems = new L.FeatureGroup().addTo(map);
        new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: true,
                rectangle: false, // Square tool removed
                circle: false,
                marker: false,
                circlemarker: false,
                polyline: false,
            },
        }).addTo(map);

        map.on(L.Draw.Event.CREATED, function(event) {
            let layer = event.layer;
            drawnItems.addLayer(layer);
            let geojson = layer.toGeoJSON();
            let areaMeters = turf.area(geojson);
            let areaFeet = Math.round(areaMeters * 10.7639);
            document.getElementById('area').textContent = areaFeet.toLocaleString();
        });

        document.getElementById('clearResults').addEventListener('click', function() {
            drawnItems.clearLayers();
            document.getElementById('area').textContent = "";
            document.getElementById('capture').textContent = "";
            document.getElementById('gallonsPerInch').textContent = "";
        });

        document.getElementById('calculate').addEventListener('click', function() {
            let area = parseFloat(document.getElementById('area').textContent.replace(/,/g, ''));
            let rainfall = parseFloat(document.getElementById('rainfall').value);
            if (!isNaN(area) && !isNaN(rainfall)) {
                let gallonsPerInch = Math.round(area * 0.623);
                let totalCapture = Math.round(gallonsPerInch * rainfall);
                document.getElementById('gallonsPerInch').textContent = gallonsPerInch.toLocaleString();
                document.getElementById('capture').textContent = totalCapture.toLocaleString();
            }
        });

        document.getElementById('searchAddress').addEventListener('click', function() {
            let address = document.getElementById('addressInput').value;
            if (address.trim() !== "") {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            let lat = data[0].lat;
                            let lon = data[0].lon;
                            map.setView([lat, lon], 19); // Zooms to level 19 when address is found
                        } else {
                            alert("Address not found. Try again.");
                        }
                    })
                    .catch(error => console.error('Error fetching address:', error));
            }
        });
    </script>
</body>
</html>
