<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainwater Capture Map</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }

        #area,
        #capture,
        #gallonsPerInch {
            font-weight: bold;
        }

        #calculate {
            background-color: pink;
            color: black;
            font-size: 1.2em;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #results-space {
            margin-bottom: 20px;
        }

        #areasList {
            margin-top: 10px;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</head>

<body>
    <div id="map"></div>
    <p>Enter Address: <input type="text" id="addressInput">
        <button id="searchAddress">Search</button>
    </p>
    <p>
        Enter Your Annual Rainfall (in inches):
        <input type="number" id="rainfall" />
        <br />
        <a href="https://precip.ai/rainfall-totals/zipcode/" target="_blank">
            Find Rainfall by Zip Code
        </a>
    </p>
    <button id="calculate">Calculate</button>
    <div id="results-space"></div>
    <p>Area (square feet): <span id="area"></span></p>
    <p>Potential Annual Rainwater Harvesting in Gallons: <span id="capture"></span></p>
    <p>Gallons of Rainwater per Inch of Rain: <span id="gallonsPerInch"></span></p>
    <div id="areasList"></div>

    <script>
        window.onload = function() {
            function initializeMap() {
                const map = L.map('map').setView([32.7157, -117.1611], 11);

                // Set max zoom level to 19 for more zoom in
                L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidGhlcGVybWFjdWx0dXJlbGFiIiwiYSI6ImNtOGs5d2Y5bzBrdGkyanB0aXpsd254a3YifQ.5pF_SIB5dJQGQy-Q6jTExg', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                    maxZoom: 19, // Increase max zoom level to 19
                    id: 'mapbox/satellite-v9',
                    tileSize: 512,
                    zoomOffset: -1,
                }).addTo(map);

                let drawnItems = new L.FeatureGroup().addTo(map);
                let drawControl = new L.Control.Draw({
                    edit: {
                        featureGroup: drawnItems
                    },
                    draw: {
                        circle: false,
                        marker: false,
                        circlemarker: false,
                        polyline: false,
                    },
                });

                map.addControl(drawControl);

                map.on(L.Draw.Event.CREATED, function(event) {
                    let layer = event.layer;
                    drawnItems.addLayer(layer);
                    let geojson = layer.toGeoJSON();
                    let areaMeters = turf.area(geojson);
                    let areaFeet = Math.round(areaMeters * 10.7639);
                    document.getElementById('area').textContent = areaFeet.toLocaleString();
                    let rainfall = parseFloat(document.getElementById('rainfall').value) || 0;
                    let capture = rainfall * areaFeet * 0.623;
                    document.getElementById('capture').textContent = capture.toLocaleString();
                    document.getElementById('gallonsPerInch').textContent = (areaFeet * 0.623).toLocaleString();
                });

                // Handle address search functionality
                document.getElementById('searchAddress').addEventListener('click', function() {
                    const address = document.getElementById('addressInput').value;
                    const accessToken = 'pk.eyJ1IjoidGhlcGVybWFjdWx0dXJlbGFiIiwiYSI6ImNtOGs5d2Y5bzBrdGkyanB0aXpsd254a3YifQ.5pF_SIB5dJQGQy-Q6jTExg';

                    if (address) {
                        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${accessToken}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.features && data.features.length > 0) {
                                    const coordinates = data.features[0].center;
                                    map.setView([coordinates[1], coordinates[0]], 16);  // Zoom level 16 for detailed view
                                } else {
                                    alert('Address not found.');
                                }
                            })
                            .catch(error => {
                                console.error('Error geocoding address:', error);
                                alert('An error occurred while searching for the address.');
                            });
                    } else {
                        alert('Please enter an address.');
                    }
                });
            }
            initializeMap();
        };
    </script>
</body>
</html>
