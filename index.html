<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainwater Capture Map</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }

        #area,
        #capture,
        #gallonsPerInch {
            font-weight: bold;
        }

        #calculate {
            background-color: pink;
            color: black;
            font-size: 1.2em;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #clearResults {
            background-color: lightgray;
            color: black;
            font-size: 1em;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #results-space {
            margin-bottom: 20px;
        }

        #areasList {
            margin-top: 10px;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.14/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/mapbox-gl@2.9.1/dist/mapbox-gl.js"></script>
    <link href="https://unpkg.com/mapbox-gl@2.9.1/dist/mapbox-gl.css" rel="stylesheet" />
</head>

<body>
    <div id="map"></div>
    <p>Enter Address: <input type="text" id="addressInput">
        <button id="searchAddress">Search</button>
    </p>
    <p>
        Enter Your Annual Rainfall (in inches):
        <input type="number" id="rainfall" value="12" />
        <br />
        <a href="https://precip.ai/rainfall-totals/zipcode/" target="_blank">
            Find Rainfall by Zip Code
        </a>
    </p>
    <button id="calculate">Calculate</button>
    <button id="clearResults">Clear Results</button>
    <div id="results-space"></div>
    <p>Area (square feet): <span id="area"></span></p>
    <p>Potential Annual Rainwater Harvesting in Gallons: <span id="capture"></span></p>
    <p>Gallons of Rainwater per Inch of Rain: <span id="gallonsPerInch"></span></p>
    <div id="areasList"></div>

    <script>
        window.onload = function() {
            // Create Mapbox map with hybrid (satellite) view
            mapboxgl.accessToken = 'pk.eyJ1IjoidGhlcGVybWFjdWx0dXJlbGFiIiwiYSI6ImNtOGs5d2Y5bzBrdGkyanB0aXpsd254a3YifQ.5pF_SIB5dJQGQy-Q6jTExg';
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-v9', // Hybrid (satellite) view
                center: [ -117.1611, 32.7157 ],
                zoom: 12,
                maxZoom: 23 // Set max zoom level to 23
            });

            // Add zoom and rotation controls to the map
            map.addControl(new mapboxgl.NavigationControl());

            // Create Leaflet map
            const leafletMap = L.map('map').setView([32.7157, -117.1611], 11);

            // Use Mapbox Satellite Tiles with Leaflet
            L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=' + mapboxgl.accessToken, {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery &copy; <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 23, // Set max zoom level to 23
            }).addTo(leafletMap);

            let drawnItems = new L.FeatureGroup().addTo(leafletMap);
            let drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems
                },
                draw: {
                    marker: false,
                    polyline: false,
                    polygon: {
                        allowIntersection: false, // Disable polygon intersection
                        showArea: true, // Show area when drawing
                    },
                    circle: false,
                    circlemarker: false,
                },
            });

            leafletMap.addControl(drawControl);

            leafletMap.on(L.Draw.Event.CREATED, function(event) {
                let layer = event.layer;
                drawnItems.addLayer(layer);
                let geojson = layer.toGeoJSON();
                let areaMeters = turf.area(geojson);
                let areaFeet = Math.round(areaMeters * 10.7639);
                document.getElementById('area').textContent = areaFeet.toLocaleString();
                let rainfall = parseFloat(document.getElementById('rainfall').value);
                let capture = areaFeet * rainfall * 0.62; // conversion factor for gallons per inch of rain
                document.getElementById('capture').textContent = capture.toLocaleString();
                document.getElementById('gallonsPerInch').textContent = (areaFeet * 0.62).toLocaleString();
            });

            // Clear results
            document.getElementById('clearResults').addEventListener('click', function() {
                document.getElementById('area').textContent = '';
                document.getElementById('capture').textContent = '';
                document.getElementById('gallonsPerInch').textContent = '';
                drawnItems.clearLayers();
            });

            // Address search function (uses Nominatim API)
            document.getElementById('searchAddress').addEventListener('click', function() {
                const address = document.getElementById('addressInput').value;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${address}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const lat = data[0].lat;
                            const lon = data[0].lon;
                            leafletMap.setView([lat, lon], 19); // Set zoom to 19 when an address is found
                        } else {
                            alert("Address not found.");
                        }
                    })
                    .catch(error => alert("Error fetching address."));
            });
        }
    </script>
</body>
</html>

