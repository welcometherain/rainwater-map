<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainwater Harvesting Calculator</title>
    <style>
        /* Basic styling will go here later */
        body { font-family: sans-serif; margin: 20px; }
        .input-section { margin-bottom: 20px; }
        .catchment-area { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Rainwater Harvesting Calculator</h1>

    <div class="input-section">
        <h2>Location</h2>
        <div>
            <input type="radio" id="zipCodeOption" name="locationType" value="zip" checked>
            <label for="zipCodeOption">ZIP Code</label>
            <input type="text" id="zipCode" placeholder="Enter ZIP Code" value="92082">
        </div>
        <div>
            <input type="radio" id="addressOption" name="locationType" value="address">
            <label for="addressOption">Address</label>
            <div id="addressFields" style="display: none;">
                <input type="text" id="street" placeholder="Street Address"><br><br>
                <input type="text" id="city" placeholder="City">
                <input type="text" id="state" placeholder="State (e.g., CA)">
            </div>
        </div>
    </div>

    <div class="input-section">
        <h2>Total Annual Rainfall (inches)</h2>
        <input type="text" id="annualRainfall" readonly placeholder="Fetching rainfall data...">
    </div>

    <div class="input-section">
        <h2>Catchment Areas</h2>
        <div id="catchmentAreas">
            <div class="catchment-area">
                <label for="catchmentName1">Catchment Name:</label>
                <input type="text" id="catchmentName1" placeholder="e.g., Roof, Patio">
                <label for="catchmentArea1">Area (sq ft):</label>
                <input type="number" id="catchmentArea1" placeholder="Enter area in square feet">
            </div>
        </div>
        <button id="addCatchment">Add Catchment Area</button>
    </div>

    <button id="calculateButton">Calculate Harvest</button>

    <div class="results-section" style="margin-top: 20px;">
        <h2>Rainfall Data</h2>
        <div id="rainfallData"></div>

        <h2>Harvestable Water</h2>
        <div id="harvestedWater"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const zipCodeOption = document.getElementById('zipCodeOption');
            const addressOption = document.getElementById('addressOption');
            const addressFields = document.getElementById('addressFields');
            const zipCodeInput = document.getElementById('zipCode');
            const calculateButton = document.getElementById('calculateButton');
            const rainfallDataDiv = document.getElementById('rainfallData');

            zipCodeOption.addEventListener('change', function() {
                addressFields.style.display = 'none';
            });

            addressOption.addEventListener('change', function() {
                addressFields.style.display = 'block';
            });

            const addCatchmentButton = document.getElementById('addCatchment');
            const catchmentAreasDiv = document.getElementById('catchmentAreas');
            let catchmentCount = 1;

            addCatchmentButton.addEventListener('click', function() {
                catchmentCount++;
                const newCatchmentDiv = document.createElement('div');
                newCatchmentDiv.classList.add('catchment-area');
                newCatchmentDiv.innerHTML = `
                    <label for="catchmentName${catchmentCount}">Catchment Name:</label>
                    <input type="text" id="catchmentName${catchmentCount}" placeholder="e.g., Garden">
                    <label for="catchmentArea${catchmentCount}">Area (sq ft):</label>
                    <input type="number" id="catchmentArea${catchmentCount}" placeholder="Enter area in square feet">
                `;
                catchmentAreasDiv.appendChild(newCatchmentDiv);
            });

            calculateButton.addEventListener('click', function() {
                const locationType = document.querySelector('input[name="locationType"]:checked').value;
                let zipCode;

                if (locationType === 'zip') {
                    zipCode = zipCodeInput.value;
                    if (zipCode) {
                        getCoordinatesFromZipCode(zipCode);
                    } else {
                        alert('Please enter a ZIP code.');
                    }
                } else {
                    alert('Address lookup is not yet implemented.');
                }
            });

            function getCoordinatesFromZipCode(zip) {
                const apiUrl = `https://api.zippopotam.us/us/${zip}`;

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.places && data.places.length > 0) {
                            const latitude = data.places[0].latitude;
                            const longitude = data.places[0].longitude;
                            rainfallDataDiv.innerHTML = `<p>Latitude: ${latitude}</p><p>Longitude: ${longitude}</p>`;
                            getRainfallData(latitude, longitude);
                            console.log('Latitude:', latitude, 'Longitude:', longitude);
                        } else {
                            rainfallDataDiv.innerHTML = '<p>Invalid ZIP code.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching coordinates:', error);
                        rainfallDataDiv.innerHTML = '<p>Failed to fetch coordinates. Please try again.</p>';
                    });
            }

            function getRainfallData(latitude, longitude) {
                const startDate = '2020-01-01';
                const endDate = '2020-12-31';
                const apiUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&monthly=precipitation_sum`;
                const annualRainfallInput = document.getElementById('annualRainfall');
                const rainfallDataDiv = document.getElementById('rainfallData');

                annualRainfallInput.value = 'Fetching...';
                rainfallDataDiv.innerHTML = '';

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Rainfall API Response:', data);
                        if (data.monthly && data.monthly.precipitation_sum && data.monthly.time) {
                            const monthlyPrecipitationMm = data.monthly.precipitation_sum;
                            const monthlyPrecipitationInches = monthlyPrecipitationMm.map(mm => (mm / 25.4).toFixed(2));
                            const monthlyTimes = data.monthly.time;
                            let rainfallText = '<h3>Monthly Rainfall (2020):</h3><ul>';
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            let totalAnnualRainfallInches = 0;
                            console.log('monthlyTimes:', monthlyTimes);
                            console.log('monthlyPrecipitationInches:', monthlyPrecipitationInches);
                            for (let i = 0; i < monthlyTimes.length; i++) {
                                const monthNumber = parseInt(monthlyTimes[i].split('-')[1]);
                                const monthIndex = monthNumber - 1;
                                const rainfallValue = parseFloat(monthlyPrecipitationInches[i]);
                                console.log(`Month Number: ${monthNumber}, Index: ${monthIndex}, Rainfall: ${rainfallValue} inches`);
                                if (months[monthIndex] !== undefined && !isNaN(rainfallValue)) {
                                    rainfallText += `<li>${months[monthIndex]}: ${rainfallValue.toFixed(2)} inches</li>`;
                                    totalAnnualRainfallInches += rainfallValue;
                                } else {
                                    console.warn(`Invalid month index or rainfall value at index ${i}`);
                                }
                            }
                            rainfallText += '</ul>';
                            rainfallDataDiv.innerHTML = rainfallText;
                            console.log('Total Annual Rainfall (inches):', totalAnnualRainfallInches.toFixed(2));
                            annualRainfallInput.value = totalAnnualRainfallInches.toFixed(2);
                        } else {
                            rainfallDataDiv.innerHTML = '<p>Could not retrieve monthly rainfall data for 2020.</p>';
                            annualRainfallInput.value = 'Error fetching data';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching rainfall data:', error);
                        rainfallDataDiv.innerHTML = '<p>Failed to fetch rainfall data. Please try again.</p>';
                        annualRainfallInput.value = 'Error';
                    });
            }
        });
    </script>
</body>
</html>
